# TCP의 연결 해제: 4-웨이 핸드셰이크와 TIME_WAIT

### 과정

![](https://velog.velcdn.com/images/zinna_1109/post/7888961b-a7ec-40ba-bfc1-f24054110d13/image.png)

1. 먼저 클라이언트가 연결을 닫으려고 할 때 FIN으로 설정된 세그먼트를 보냄
   그리고 클라이언트는 FIN_WAIT_1 상태로 들어가고 서버의 응답을 기다림

2. 서버는 클라이언트로 ACK라는 승인 세그먼트를 보내고 CLOSE_WAIT 상태에 들어감.
   클라이언트가 세그먼트를 받으면 FIN_WAIT_2 상태에 들어감

3. 서버는 LAST_ACK 상태가 되며 일정 시간 이후에 클라이언트에 FIN이라는 세그먼트를 보냄

4. 클라이언트는 TIME_WAIT 상태가 되고 다시 서버로 ACK를 보내서 서버는 CLOSED 상태가 되며, 이후 클라이언트는 **어느 정도의 시간 (TIME_WAIT으로 설정된 시간)을 대기한 뒤** 연결이 닫힘

#### TIME_WAIT의 필요성

- 지연 패킷을 받기 위해 필요(3단계에서 서버가 보내는 FIN이 늦게 도착할 수도 있음)

  - 데이터의 무결성 (일관성, 정확성) 보장. 데이터를 전부 수신할 수 있게 함

- 연결을 올바르게 닫기 위함 (클라이언트와 서버의 연결을 모두 닫기 위함)

  - cf) 만약 CLOSED가 아닌 LAST_ACK 상태로 서버가 남아 있다면 그 다음 연결 때 오류가 발생

- 2배의 최대 세그먼트 수명(MSL, maximum segment lifetime)을 기다린다. 기본적인 MSL은 2분. => 4분 기다림 (윈도우 기준, 우분투는 60초로 설정되어 있음)
